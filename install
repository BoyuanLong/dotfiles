#!/bin/bash
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

usage() {
    echo -e "${GREEN}USAGE${NC}: ./install"
    echo -e "${GREEN}Install ZSH${NC}: sudo apt install zsh"
    echo -e "${GREEN}Change Shell${NC}: chsh -s \$(command -v zsh)"
    echo -e "${GREEN}Install TMUX${NC}: sudo apt install tmux"
}

UPDATE_MODE=0

while getopts 'hu' opt; do
    case "$opt" in
    h)
        usage
        exit
        ;;
    u)
        UPDATE_MODE=1
        ;;
    *)
        usage
        exit
        ;;
    esac
done

echo "======================"
echo "Starting install script..."
git submodule update --init --recursive && echo -e "${GREEN}Finished updating submodules${NC}"

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# dotfiles
echo "====== dotfiles ======"
if [[ "$UPDATE_MODE" == 1 ]]; then
    echo "Update mode!"
elif [[ ! -d ~/.dotfiles ]]; then
    ln -sfn "${BASEDIR}" ~/.dotfiles && echo -e "${GREEN}Linked dotfiles directory${NC}"
else
    echo -e "${RED}Error: dotfiles folder exists!${NC}"
fi

# vim
echo "====== vim ======"
ln -s -f -n "${BASEDIR}/vim" ~/.vim && echo -e "${GREEN}Linked vim directory${NC}"
if [[ ! -f ~/.vimrc ]] || ! grep -q "vimrc.shared" ~/.vimrc; then
    echo 'source ~/.dotfiles/vim/vimrc.shared' >> ~/.vimrc
    echo -e "${GREEN}Added source line to ~/.vimrc${NC}"
else
    echo "~/.vimrc already sources vimrc.shared"
fi

# zsh
echo "====== zsh ======"
if ! command -v zsh &>/dev/null; then
    echo -e "${RED}WARNING: No zsh installed! Please install zsh first${NC}"
else
    if [[ ! -f ~/.zshrc ]] || ! grep -q "zshrc.shared" ~/.zshrc; then
        echo 'source ~/.dotfiles/zsh/zshrc.shared' >> ~/.zshrc
        echo -e "${GREEN}Added source line to ~/.zshrc${NC}"
    else
        echo "~/.zshrc already sources zshrc.shared"
    fi
fi

# tmux
echo "====== tmux ======"
if ! command -v tmux &>/dev/null; then
    echo -e "${RED}WARNING: No tmux installed! Please install tmux first${NC}"
else
    if [[ ! -f ~/.tmux.conf ]] || ! grep -q "tmux.conf.shared" ~/.tmux.conf; then
        echo 'source-file ~/.dotfiles/tmux/tmux.conf.shared' >> ~/.tmux.conf
        echo -e "${GREEN}Added source line to ~/.tmux.conf${NC}"
    else
        echo "~/.tmux.conf already sources tmux.conf.shared"
    fi
fi

# git
echo "====== git ======"
gituser=$(git config --global --includes user.name || true)
gitemail=$(git config --global --includes user.email || true)
if [[ -z "$gituser" ]]; then
    read -p 'Git Username: ' gituser
    git config --global user.name "$gituser"
else
    echo "Current git user is: $gituser"
fi

if [[ -z "$gitemail" ]]; then
    read -p 'Git Email: ' gitemail
    git config --global user.email "$gitemail"
else
    echo "Current git email is: $gitemail"
fi

git config --global core.excludesfile ~/.dotfiles/git/gitignore_global
git config --global include.path ~/.dotfiles/git/gitconfig
echo -e "${GREEN}Linked git files${NC}"

# ssh
echo "====== ssh ======"
if [[ "$UPDATE_MODE" == 0 ]]; then
    ( ssh-keygen -t ed25519 -C "$gitemail" || ssh-keygen -t rsa -b 4096 -C "$gitemail" ) && echo -e "${GREEN}ssh key generated${NC}"
else
    echo "Update mode!"
fi
