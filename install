#!/bin/bash
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

usage() {
    echo -e "${GREEN}USAGE${NC}: ./install"
    echo -e "${GREEN}Install ZSH${NC}: sudo apt install zsh"
    echo -e "${GREEN}Change Shell${NC}: chsh -s \$(command -v zsh)"
    echo -e "${GREEN}Install TMUX${NC}: sudo apt install tmux"
}

UPDATE_MODE=0

while getopts 'hu' opt; do
    case "$opt" in
    h)
        usage
        exit
        ;;
    u)
        UPDATE_MODE=1
        ;;
    *)
        usage
        exit
        ;;
    esac
done

echo "======================"
echo "Starting install script..."
git submodule update --init --recursive && echo -e "${GREEN}Finished updating submodules${NC}"

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# dotfiles
echo "====== dotfiles ======"
if [[ "$UPDATE_MODE" == 1 ]]; then
    echo "Update mode!"
elif [[ ! -d ~/.dotfiles ]]; then
    ln -sfn "${BASEDIR}" ~/.dotfiles && echo -e "${GREEN}Linked dotfiles directory${NC}"
else
    echo -e "${RED}Error: dotfiles folder exists!${NC}"
fi

# vim
echo "====== vim ======"
ln -s -f -n "${BASEDIR}/vim" ~/.vim && echo -e "${GREEN}Linked vim files${NC}"

# zsh
echo "====== zsh ======"
if ! command -v zsh &>/dev/null; then
    echo -e "${RED}WARNING: No zsh installed! Please install zsh first${NC}"
else
    ln -s -f "${BASEDIR}/zsh/zshrc" ~/.zshrc && echo -e "${GREEN}Linked zsh files${NC}"
fi

# tmux
echo "====== tmux ======"
if ! command -v tmux &>/dev/null; then
    echo -e "${RED}WARNING: No tmux installed! Please install tmux first${NC}"
else
    ln -s -f "${BASEDIR}/tmux/tmux.conf" ~/.tmux.conf && echo -e "${GREEN}Linked tmux files${NC}"
fi

# git
echo "====== git ======"
gituser=$(git config --global --includes user.name || true)
gitemail=$(git config --global --includes user.email || true)
if [[ -z "$gituser" ]]; then
    read -p 'Git Username: ' gituser
    git config --global user.name "$gituser"
else
    echo "Current git user is: $gituser"
fi

if [[ -z "$gitemail" ]]; then
    read -p 'Git Email: ' gitemail
    git config --global user.email "$gitemail"
else
    echo "Current git email is: $gitemail"
fi

git config --global core.excludesfile ~/.dotfiles/git/gitignore_global
git config --global include.path ~/.dotfiles/git/gitconfig
echo -e "${GREEN}Linked git files${NC}"

# ssh
echo "====== ssh ======"
if [[ "$UPDATE_MODE" == 0 ]]; then
    ( ssh-keygen -t ed25519 -C "$gitemail" || ssh-keygen -t rsa -b 4096 -C "$gitemail" ) && echo -e "${GREEN}ssh key generated${NC}"
else
    echo "Update mode!"
fi

# recommended tools
echo "====== recommended tools ======"
YELLOW='\033[0;33m'
RECOMMENDED_TOOLS=(fzf ripgrep bat fd-find eza git-delta shellcheck)
MISSING_TOOLS=()
# Map package names to commands
declare -A TOOL_COMMANDS=(
    [fzf]=fzf
    [ripgrep]=rg
    [bat]=bat
    [fd-find]=fd
    [eza]=eza
    [git-delta]=delta
    [shellcheck]=shellcheck
)
# Debian/Ubuntu alternatives
declare -A TOOL_ALT_COMMANDS=(
    [bat]=batcat
    [fd-find]=fdfind
)

for tool in "${RECOMMENDED_TOOLS[@]}"; do
    cmd="${TOOL_COMMANDS[$tool]}"
    alt="${TOOL_ALT_COMMANDS[$tool]:-}"
    if ! command -v "$cmd" &>/dev/null && ! command -v "$alt" &>/dev/null; then
        MISSING_TOOLS+=("$tool")
    fi
done

if [[ ${#MISSING_TOOLS[@]} -gt 0 ]]; then
    echo -e "${YELLOW}The following recommended tools are not installed:${NC}"
    for tool in "${MISSING_TOOLS[@]}"; do
        echo -e "  ${YELLOW}- $tool${NC}"
    done
    echo -e "Install all with: ${GREEN}sudo apt install ${MISSING_TOOLS[*]}${NC}"
    echo -e "Or on macOS:      ${GREEN}brew install ${MISSING_TOOLS[*]}${NC}"
else
    echo -e "${GREEN}All recommended tools are installed!${NC}"
fi
